$(function() {
    // PL Home
    $("#studioList").change(function(event) {
        loadTeams(this.value);
    });
    
    // Team Management
    $("#teamDataTable").dataTable();
    
    // Accomodation management
    $("#dateOfArrivals").datepicker({ dateFormat: 'dd/mm/yy', showOn: 'button', buttonImage: contextRoot + '/images/calendar.gif', buttonImageOnly: true});
    $("#dateOfDeparture").datepicker({ dateFormat: 'dd/mm/yy', showOn: 'button', buttonImage: contextRoot + '/images/calendar.gif', buttonImageOnly: true});
    $("#dateOfBirth").datepicker({ dateFormat: 'dd/mm/yy', showOn: 'button', buttonImage: contextRoot + '/images/calendar.gif', buttonImageOnly: true});
    // Move Employees
    $("#leftTeamList").change(function() {
        loadEmployees("#leftEmployeeListPanel", this.value, "leftEmployeeList");
    });
    
    $("#rightTeamList").change(function() {
        loadEmployees("#rightEmployeeListPanel", this.value, "rightEmployeeList");
    });
    
    $("#moveRightButton").click(function() {
        moveEmployees("RIGHT");
    });
    
    $("#moveLeftButton").click(function() {
        moveEmployees("LEFT");
    $("#moveDate").datepicker({ dateFormat: 'dd/mm/yy', showOn: 'button', buttonImage: contextRoot + '/images/calendar.gif', buttonImageOnly: true});
    });
    
    $("#moveDate").datepicker({ dateFormat: 'dd/mm/yy', showOn: 'button', buttonImage: contextRoot + '/images/calendar.gif', buttonImageOnly: true});
    
    // Artist Summary
    $("#artistSummaryFromDate").datepicker({ dateFormat: 'dd/mm/yy', showOn: 'button', buttonImage: contextRoot + '/images/calendar.gif', buttonImageOnly: true});
    $("#artistSummaryToDate").datepicker({ dateFormat: 'dd/mm/yy', showOn: 'button', buttonImage: contextRoot + '/images/calendar.gif', buttonImageOnly: true});
    
    $("#weekPickerDialog").dialog({
        title: 'Weeks',
        modal: true,
        autoOpen: false,
        width: 550,
        height: 300,
        buttons : {
            'Generate Graph' : function() {
                $(this).dialog('close');
                var data = $("#artistGraphWeekSelectionForm").serialize();
                var content = productionAndErrorHtml(data); 
                content += productivityHtml(data);
                $("#artistsSummaryGraphPanel").html(content);
            }
        }
    });
    
    $("#artistSummaryDateRange").submit(function(event) {
       showWeeksInRange(); 
       event.preventDefault();
    });
    
    // Master Reports
    $("#studio").change(function(event) {
        loadTeams(this.value);
    });
});

function loadTeams(studio) {
    $.ajax({
        url: contextRoot + '/teamList.htm',
        data: {studioId : studio},
        type: 'POST',
        success : function(html) {
             $("#teamListPanel").html(html);
        }
    });
}

function moveEmployees(direction) {
    $.ajax({
        url: contextRoot + '/management/move/moveEmployees.htm',
        data: {
            leftTeamId: $("#leftTeamList").val(),
            rightTeamId: $("#rightTeamList").val(),
            leftSelection: $("#leftEmployeeList").val(),
            rightSelection: $("#rightEmployeeList").val(),
            moveDate: $("#moveDate").val(),
            direction: direction
        },
        type: 'POST',
        success : function(xml) {
           $("#leftEmployeeListPanel").html($("leftEmployees", xml).text());
           $("#rightEmployeeListPanel").html($("rightEmployees", xml).text());
           $("#moveDateErrorPanel").html($("missingDate", xml).text());
        }
    });
}

function loadEmployees(targetPanel, teamId, listId) {
    $.ajax({
        url: contextRoot + '/management/move/employeeList.htm',
        data: {teamId : teamId, listId: listId},
        type: 'POST',
        success : function(html) {
            $(targetPanel).html(html);
        }
    });
}

function showWeeksInRange() {
    $.ajax({
        url: contextRoot + '/graphs/artists/weekList.htm',
        data: $("#artistSummaryDateRange").serialize(),
        type: 'POST',
        success : function(html) {
           $("#weekPickerDialog").html(html);
           $("#weekPickerDialog").dialog('open');
        }
    });
}

function productionAndErrorHtml(data) {
    var content = "<h3>Production & Error Percentage</h3>";
    content += "<img src=\"" + contextRoot + "/graphs/artists/production_and_error.htm?" + data + "\" />";
    return content;
}

function productivityHtml(data) {
    var content = "<h3>Productivity</h3>";
    content += "<img src=\"" + contextRoot + "/graphs/artists/productivity.htm?" + data + "\" />";
    return content;
}
